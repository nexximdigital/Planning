<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Planning Gantt</title>
  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #gantt { width: 100%; height: 600px; }
  </style>
</head>
<body>
  <div id="gantt"></div>

  <script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.umd.js"></script>
  <script>
    // ðŸ“Œ Noms des mois en franÃ§ais
    const moisFR = ["Janvier","FÃ©vrier","Mars","Avril","Mai","Juin","Juillet","AoÃ»t","Septembre","Octobre","Novembre","DÃ©cembre"];

    // ðŸ”¹ RÃ©cupÃ©ration du JSON Base64 depuis l'URL
    function getURLParameter(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const encodedData = getURLParameter('data');
    if (!encodedData) {
      document.getElementById('gantt').innerHTML = "Aucune donnÃ©e disponible.";
      throw new Error("Pas de data");
    }

    const taches = JSON.parse(atob(encodedData));

    // ðŸ”¹ Calcul des dates min/max + marge de 2 mois
    let minDate = null;
    let maxDate = null;
    taches.forEach(t => {
      const s = new Date(t.start);
      const e = new Date(t.end);
      if (!minDate || s < minDate) minDate = s;
      if (!maxDate || e > maxDate) maxDate = e;
    });
    minDate.setMonth(minDate.getMonth() - 2);
    maxDate.setMonth(maxDate.getMonth() + 2);

    // ðŸ”¹ CrÃ©ation du Gantt
    const gantt = new Gantt("#gantt", taches, {
      view_mode: "Month",
      date_format: "YYYY-MM-DD",
      custom_popup_html: null,
      on_view_change: function(mode) {
        if(mode === "Month") {
          document.querySelectorAll(".gantt .month").forEach(function(el){
            const date = new Date(el.dataset.date);
            el.innerText = moisFR[date.getMonth()] + " " + date.getFullYear();
          });
        }
      },
      on_date_change: function(task, start, end) {
        console.log(`TÃ¢che ${task.name} dÃ©placÃ©e : ${start} â†’ ${end}`);
        // Ici tu pourras envoyer les nouvelles dates vers Glide via Webhook si besoin
      }
    });

    // ðŸ”¹ Limiter la vue
    gantt.change_view_mode("Month");
    gantt.change_start_date(minDate.toISOString().split('T')[0]);
    gantt.change_end_date(maxDate.toISOString().split('T')[0]);
  </script>
</body>
</html>
