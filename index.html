<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planning Gantt</title>
  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 10px; 
      overflow-x: auto;
    }
    #gantt { 
      width: 100%; 
      min-height: 500px;
    }
    .gantt .upper-text, .gantt .lower-text {
      font-family: Arial, sans-serif !important;
    }
  </style>
</head>
<body>
  <div id="gantt"></div>
  <script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.umd.js"></script>
  <script>
    // üìå Configuration des mois en fran√ßais
    const moisFR = ["Janv.","F√©vr.","Mars","Avr.","Mai","Juin","Juil.","Ao√ªt","Sept.","Oct.","Nov.","D√©c."];
    const moisComplets = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
    
    // üîπ R√©cup√©ration du JSON Base64 depuis l'URL
    function getURLParameter(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const encodedData = getURLParameter('data');
    if (!encodedData) {
      document.getElementById('gantt').innerHTML = "<p style='padding:20px;color:#666;'>‚ö†Ô∏è Aucune donn√©e disponible. V√©rifiez que le param√®tre 'data' est pr√©sent dans l'URL.</p>";
      throw new Error("Pas de donn√©es √† afficher");
    }

    let taches = [];
    try {
      taches = JSON.parse(atob(encodedData));
    } catch(e) {
      document.getElementById('gantt').innerHTML = "<p style='padding:20px;color:red;'>‚ùå Erreur lors du d√©codage des donn√©es.</p>";
      throw e;
    }

    // üîπ Calcul des dates min/max avec marge de 1-2 mois
    let minDate = null;
    let maxDate = null;
    
    taches.forEach(t => {
      const s = new Date(t.start);
      const e = new Date(t.end);
      if (!minDate || s < minDate) minDate = new Date(s);
      if (!maxDate || e > maxDate) maxDate = new Date(e);
    });

    // Ajout d'une marge : 1 mois avant, 2 mois apr√®s
    minDate.setMonth(minDate.getMonth() - 1);
    maxDate.setMonth(maxDate.getMonth() + 2);

    // üîπ Cr√©ation du Gantt
    const gantt = new Gantt("#gantt", taches, {
      view_mode: "Month",
      date_format: "YYYY-MM-DD",
      custom_popup_html: null,
      language: 'fr',
      on_date_change: function(task, start, end) {
        console.log(`T√¢che ${task.name} d√©plac√©e : ${start} ‚Üí ${end}`);
      }
    });

    // üîπ Fonction pour traduire les en-t√™tes en fran√ßais
    function traduireEnTetes() {
      setTimeout(() => {
        // Traduction des mois dans les en-t√™tes
        document.querySelectorAll('.gantt .upper-text').forEach(el => {
          const texte = el.textContent.trim();
          
          // Pour les mois (format: "January 2024" ou "Jan 2024")
          const moisAnglais = ["January","February","March","April","May","June","July","August","September","October","November","December"];
          moisAnglais.forEach((mois, index) => {
            if (texte.includes(mois)) {
              el.textContent = texte.replace(mois, moisComplets[index]);
            }
          });
          
          // Pour les abr√©viations
          const moisAnglaisAbrv = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          moisAnglaisAbrv.forEach((mois, index) => {
            if (texte === mois || texte.startsWith(mois + " ")) {
              el.textContent = texte.replace(mois, moisFR[index]);
            }
          });
        });

        // Traduction des ann√©es et autres textes si n√©cessaire
        document.querySelectorAll('.gantt .lower-text').forEach(el => {
          // Les ann√©es restent telles quelles, rien √† faire
        });
      }, 100);
    }

    // üîπ Application initiale de la traduction
    traduireEnTetes();

    // üîπ R√©appliquer la traduction lors des changements de vue
    const observateur = new MutationObserver(() => {
      traduireEnTetes();
    });

    const ganttElement = document.querySelector('#gantt');
    if (ganttElement) {
      observateur.observe(ganttElement, {
        childList: true,
        subtree: true
      });
    }

    // üîπ Forcer la vue Month au chargement
    setTimeout(() => {
      gantt.change_view_mode('Month');
      traduireEnTetes();
    }, 200);

  </script>
</body>
</html>
