<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planning Gantt</title>
  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 10px; 
      overflow-x: auto;
    }
    #gantt { 
      width: 100%; 
      min-height: 500px;
    }
    .gantt .upper-text, .gantt .lower-text {
      font-family: Arial, sans-serif !important;
    }
    
    /* üé® Styles pour les couleurs personnalis√©es */
    .bar-wrapper .bar {
      transition: all 0.3s ease;
    }
  </style>
  <style id="custom-colors">
    /* Les couleurs personnalis√©es seront inject√©es ici dynamiquement */
  </style>
</head>
<body>
  <div id="gantt"></div>
  <script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.umd.js"></script>
  <script>
    // üìå Configuration des mois en fran√ßais
    const moisFR = ["Janv.","F√©vr.","Mars","Avr.","Mai","Juin","Juil.","Ao√ªt","Sept.","Oct.","Nov.","D√©c."];
    const moisComplets = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
    
    // üîπ R√©cup√©ration du JSON Base64 depuis l'URL
    function getURLParameter(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const encodedData = getURLParameter('data');
    if (!encodedData) {
      document.getElementById('gantt').innerHTML = "<p style='padding:20px;color:#666;'>‚ö†Ô∏è Aucune donn√©e disponible. V√©rifiez que le param√®tre 'data' est pr√©sent dans l'URL.</p>";
      throw new Error("Pas de donn√©es √† afficher");
    }

    let taches = [];
    try {
      taches = JSON.parse(atob(encodedData));
    } catch(e) {
      document.getElementById('gantt').innerHTML = "<p style='padding:20px;color:red;'>‚ùå Erreur lors du d√©codage des donn√©es.</p>";
      throw e;
    }

    // üîπ Calcul des dates min/max avec marge de 1-2 mois
    let minDate = null;
    let maxDate = null;
    
    taches.forEach(t => {
      const s = new Date(t.start);
      const e = new Date(t.end);
      if (!minDate || s < minDate) minDate = new Date(s);
      if (!maxDate || e > maxDate) maxDate = new Date(e);
    });

    // Sauvegarde des dates originales
    const dateDebut = new Date(minDate);
    const dateFin = new Date(maxDate);
    
    // Ajout d'une marge : 1 mois avant, 2 mois apr√®s
    dateDebut.setMonth(dateDebut.getMonth() - 1);
    dateFin.setMonth(dateFin.getMonth() + 2);

    // üîπ Ajout des couleurs personnalis√©es aux t√¢ches
    taches.forEach(t => {
      // Si une couleur est d√©finie dans les donn√©es, on l'utilise
      if (t.custom_class) {
        t.custom_class = t.custom_class;
      } else if (t.color) {
        // Sinon on cr√©e une classe custom
        t.custom_class = 'custom-color-' + t.id;
      }
    });

    // üîπ Cr√©ation du Gantt
    const gantt = new Gantt("#gantt", taches, {
      view_mode: "Month",
      date_format: "YYYY-MM-DD",
      custom_popup_html: null,
      language: 'fr',
      view_modes: ['Day', 'Week', 'Month'],
      bar_height: 30,
      padding: 18,
      on_date_change: function(task, start, end) {
        console.log(`T√¢che ${task.name} d√©plac√©e : ${start} ‚Üí ${end}`);
      }
    });

    // üîπ Fonction pour traduire les en-t√™tes en fran√ßais
    function traduireEnTetes() {
      setTimeout(() => {
        // Traduction des mois dans les en-t√™tes
        document.querySelectorAll('.gantt .upper-text').forEach(el => {
          const texte = el.textContent.trim();
          
          // Pour les mois (format: "January 2024" ou "Jan 2024")
          const moisAnglais = ["January","February","March","April","May","June","July","August","September","October","November","December"];
          moisAnglais.forEach((mois, index) => {
            if (texte.includes(mois)) {
              el.textContent = texte.replace(mois, moisComplets[index]);
            }
          });
          
          // Pour les abr√©viations
          const moisAnglaisAbrv = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          moisAnglaisAbrv.forEach((mois, index) => {
            if (texte === mois || texte.startsWith(mois + " ")) {
              el.textContent = texte.replace(mois, moisFR[index]);
            }
          });
        });

        // Traduction des ann√©es et autres textes si n√©cessaire
        document.querySelectorAll('.gantt .lower-text').forEach(el => {
          // Les ann√©es restent telles quelles, rien √† faire
        });
      }, 100);
    }

    // üîπ Application initiale de la traduction
    traduireEnTetes();
    
    // üé® Application des couleurs personnalis√©es
    function appliquerCouleurs() {
      const styleSheet = document.getElementById('custom-colors');
      let cssRules = '';
      
      taches.forEach(t => {
        if (t.color) {
          cssRules += `
            .bar-wrapper[data-id="${t.id}"] .bar {
              fill: ${t.color} !important;
            }
            .bar-wrapper[data-id="${t.id}"] .bar-progress {
              fill: ${t.color} !important;
              opacity: 0.8;
            }
          `;
        }
      });
      
      styleSheet.textContent = cssRules;
    }
    
    setTimeout(() => {
      appliquerCouleurs();
    }, 300);

    // üîπ R√©appliquer la traduction lors des changements de vue
    const observateur = new MutationObserver(() => {
      traduireEnTetes();
    });

    const ganttElement = document.querySelector('#gantt');
    if (ganttElement) {
      observateur.observe(ganttElement, {
        childList: true,
        subtree: true
      });
    }

    // üîπ Forcer la vue Month au chargement
    setTimeout(() => {
      gantt.change_view_mode('Month');
      traduireEnTetes();
      appliquerCouleurs();
      
      // üîπ Limiter l'affichage aux dates pertinentes
      const ganttContainer = document.querySelector('.gantt-container');
      if (ganttContainer) {
        // Calculer la position de scroll pour centrer sur les dates actives
        const barWrappers = document.querySelectorAll('.bar-wrapper');
        if (barWrappers.length > 0) {
          const firstBar = barWrappers[0];
          const rect = firstBar.getBoundingClientRect();
          const container = ganttContainer.closest('.gantt');
          
          // Scroll pour afficher la premi√®re t√¢che avec marge
          if (container) {
            container.scrollLeft = Math.max(0, rect.left - 200);
          }
        }
      }
    }, 300);

  </script>
</body>
</html>
